#!/bin/bash

retVal=0
for secretToDo in "$@"
do
	if [[ "$secretToDo" != */* ]]
	then
		secretToDo="v1/ci/kv/semaphore2/${secretToDo}"
	fi

	retries=0

	# shellcheck disable=SC2164
	pushd "$HOME" &>/dev/null
	retVal=$(( retVal + $? ))

	while [[ 5 -gt $retries ]]; do
		sleep $(( retries++ ))
		echo -n "try #$retries - Injecting Secret ${secretToDo} - " >&2
		vault kv get -field=script "$secretToDo" > ./__VAULT_TMPFILE && break
		echo "Failed injecting secret==$secretToDo " >&2
		rm -f ./__VAULT_TMPFILE
	done

	if [[ -f ./__VAULT_TMPFILE ]]; then
		# shellcheck disable=SC1091
		source ./__VAULT_TMPFILE && rm -f ./__VAULT_TMPFILE &>/dev/null && echo "Success injecting $secretToDo" >&2
		errSt=$?
	else
		echo "All $retries retries failed.  Giving up!" >&2
	fi
	[[ $errSt != 0 ]] && echo "Failed injecting secret==$secretToDo" >&2
	retVal=$(( retVal + errSt ))

	# shellcheck disable=SC2164
	popd &>/dev/null
	retVal=$(( retVal + $? ))
done

# ensure calling process gets a $? that makes sense
if [[ $retVal == 0 ]] ; then
	true
else
	echo "Failure injecting some secret above, returning FALSE" >&2
	false
fi

